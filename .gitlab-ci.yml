variables:
  SLURM_job_name: gitlab-ci
  SLURM_account: z19
  SLURM_partition: standard
  SLURM_qos: short

.setup_environment:  &setup_environment
  - module load PrgEnv-gnu
  - module load cray-hdf5-parallel
  - module load cray-netcdf-hdf5parallel

build-cbenchio:
  variables:
    ON_COMPUTE: "FALSE"
  stage: build
  artifacts:
    untracked: true
    paths:
      - build/src/benchio
      - build/test/test_*
  script:
    - *setup_environment
    - mkdir -p build
    - cd build

    - CXX=CC CC=cc FC=ftn cmake ../cbenchio
    - VERBOSE=1 make -j 4
    - make

run_mpi_test:
  stage: test
  needs: 
    - job: build-cbenchio
      artifacts: true
  
  
  variables:
    ON_COMPUTE: "TRUE"
    SLURM_time: "00:03:00"
    SLURM_nodes: 1
    SLURM_tasks_per_node: 40
    SLURM_exclusive: "TRUE"
  script:
    - pwd
    - module load PrgEnv-gnu
    - module load cray-hdf5-parallel
    - module load cray-netcdf-hdf5parallel
    - cp examples/mpi.yaml config.yaml
    - mkdir -p data
    - srun build/src/benchio



run_hdf5_test:
  stage: test
  needs: 
    - job: build-cbenchio
      artifacts: true
  
  
  variables:
    ON_COMPUTE: "TRUE"
    SLURM_time: "00:05:00"
    SLURM_nodes: 1
    SLURM_tasks_per_node: 40
    SLURM_exclusive: "TRUE"
  script:
    - pwd
    - module load PrgEnv-gnu
    - module load cray-hdf5-parallel
    - module load cray-netcdf-hdf5parallel
    - cp examples/hdf5.yaml config.yaml
    - mkdir -p data
    - srun build/src/benchio
  
run_posix_test:
  stage: test
  needs: 
    - job: build-cbenchio
      artifacts: true


  variables:
    ON_COMPUTE: "TRUE"
    SLURM_time: "00:05:00"
    SLURM_nodes: 1
    SLURM_tasks_per_node: 1
    SLURM_exclusive: "TRUE"
  script:
    - pwd
    - module load PrgEnv-gnu
    - module load cray-hdf5-parallel
    - module load cray-netcdf-hdf5parallel
    - cp examples/posix.yaml config.yaml
    - mkdir -p data
    - srun build/src/benchio


run_posix_direct_test:
  stage: test
  needs: 
    - job: build-cbenchio
      artifacts: true


  variables:
    ON_COMPUTE: "TRUE"
    SLURM_time: "00:05:00"
    SLURM_nodes: 1
    SLURM_tasks_per_node: 1
    SLURM_exclusive: "TRUE"
  script:
    - pwd
    - module load PrgEnv-gnu
    - module load cray-hdf5-parallel
    - module load cray-netcdf-hdf5parallel
    - cp examples/posixDirect.yaml config.yaml
    - mkdir -p data
    - srun build/src/benchio


run_posix_strided_test:
  stage: test
  needs: 
    - job: build-cbenchio
      artifacts: true


  variables:
    ON_COMPUTE: "TRUE"
    SLURM_time: "00:05:00"
    SLURM_nodes: 1
    SLURM_tasks_per_node: 1
    SLURM_exclusive: "TRUE"
  script:
    - pwd
    - module load PrgEnv-gnu
    - module load cray-hdf5-parallel
    - module load cray-netcdf-hdf5parallel
    - cp examples/posixStrided.yaml config.yaml
    - mkdir -p data
    - srun build/src/benchio

run_posix_lock_ahead_test:
  stage: test
  needs: 
    - job: build-cbenchio
      artifacts: true


  variables:
    ON_COMPUTE: "TRUE"
    SLURM_time: "00:05:00"
    SLURM_nodes: 1
    SLURM_tasks_per_node: 4
    SLURM_exclusive: "TRUE"
  script:
    - pwd
    - module load PrgEnv-gnu
    - module load cray-hdf5-parallel
    - module load cray-hdf5-parallel
    - module load cray-netcdf-hdf5parallel
    - module load cray-netcdf-hdf5parallel
    - cp examples/posixLockAhead.yaml config.yaml
    - mkdir -p data
    - srun build/src/benchio


run_unit_tests:
  stage: test
  needs: 
    - job: build-cbenchio
      artifacts: true
  variables:
    ON_COMPUTE: "TRUE"
    SLURM_time: "00:10:00"
    SLURM_nodes: 1
    SLURM_tasks_per_node: 64
    SLURM_exclusive: "TRUE"
  script:
    - pwd
    - module load PrgEnv-gnu
    - module load cray-hdf5-parallel
    - module load cray-netcdf-hdf5parallel
    - cd build
    - ctest -VV